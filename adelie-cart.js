const cat = [
    {
        "availableStock": 15,
        "bundleItems": [],
        "bundleItemsQueryHook": [],
        "categories": [
            {
                "description": "tent items",
                "id": "XtkrpdmUKXPqDsK97j21",
                "name": "Tents",
                "orgId": "1EFnp9dnRUnAWQTPO2U4"
            }
        ],
        "categoriesQueryHook": [
            "XtkrpdmUKXPqDsK97j21"
        ],
        "createdBy": "sGn9ZIc0hQPffroyZdAwcjFr7Sq2",
        "createdOn": {
            "_seconds": 1639157025,
            "_nanoseconds": 744000000
        },
        "depreciation": {
            "depreciationYears": null,
            "initialDate": null,
            "initialValue": null
        },
        "description": "side T piece for frame tents",
        "domain": "QBO",
        "id": "xJy9MTonHdlAaNUf13JZ",
        "image": {
            "downloadURL": "https://firebasestorage.googleapis.com/v0/b/adelie-logistics-dev-52205.appspot.com/o/orgs%2F1EFnp9dnRUnAWQTPO2U4%2Finventory-images%2Fside-T%2020x20.jpeg?alt=media&token=570204d1-33e7-4c60-a0c7-cab9cb271de3",
            "fileName": "side-T 20x20.jpeg"
        },
        "isActive": true,
        "isAvailable": true,
        "isTaxable": true,

        "name": "Side T",
        "notes": "",
        "orgId": "1EFnp9dnRUnAWQTPO2U4",
        "qbId": "74",
        "rates": [],
        "stock": 16,
        "syncToken": "0",
        "turnaround": null,
        "type": "rental",
        "updateSource": "qbo",
        "updatedBy": "sGn9ZIc0hQPffroyZdAwcjFr7Sq2",
        "updatedOn": {
            "_seconds": 1639157206,
            "_nanoseconds": 767000000
        }
    },
    {
        "availableStock": 20,
        "bundleItems": [],
        "bundleItemsQueryHook": [],
        "categories": [
            {
                "description": "tent items",
                "id": "XtkrpdmUKXPqDsK97j21",
                "name": "Tents",
                "orgId": "1EFnp9dnRUnAWQTPO2U4"
            }
        ],
        "categoriesQueryHook": [
            "XtkrpdmUKXPqDsK97j21"
        ],
        "createdBy": "sGn9ZIc0hQPffroyZdAwcjFr7Sq2",
        "createdOn": {
            "_seconds": 1639157025,
            "_nanoseconds": 744000000
        },
        "depreciation": {
            "depreciationYears": null,
            "initialDate": null,
            "initialValue": null
        },
        "description": "10x20 Tent",
        "domain": "QBO",
        "id": "xJy9MTonHdlBaNUf13JZ",
        "image": {
            "downloadURL": "https://www.gettent.com/images/C08Y20X20-20x20-pinnacle-1-l.jpg",
            "fileName": "side-T 20x20.jpeg"
        },
        "isActive": true,
        "isAvailable": true,
        "isTaxable": true,

        "name": "10x20 Tent",
        "notes": "",
        "orgId": "1EFnp9dnRUnAWQTPO2U4",
        "qbId": "74",
        "rates": [],
        "stock": 16,
        "syncToken": "0",
        "turnaround": null,
        "type": "rental",
        "updateSource": "qbo",
        "updatedBy": "sGn9ZIc0hQPffroyZdAwcjFr7Sq2",
        "updatedOn": {
            "_seconds": 1639157206,
            "_nanoseconds": 767000000
        }
    },
    {
        "availableStock": 100,
        "bundleItems": [],
        "bundleItemsQueryHook": [],
        "categories": [
            {
                "description": "tent items",
                "id": "XtkrpdmUKXPqDsK97j21",
                "name": "Tables",
                "orgId": "1EFnp9dnRUnAWQTPO2U4"
            }
        ],
        "categoriesQueryHook": [
            "XtkrpdmUKXPqDsK97j21"
        ],
        "createdBy": "sGn9ZIc0hQPffroyZdAwcjFr7Sq2",
        "createdOn": {
            "_seconds": 1639157025,
            "_nanoseconds": 744000000
        },
        "depreciation": {
            "depreciationYears": null,
            "initialDate": null,
            "initialValue": null
        },
        "description": "8 ft rectangle table",
        "domain": "QBO",
        "id": "xJy9MTonHdlCaNUf13JZ",
        "image": {
            "downloadURL": "https://www.gettent.com/images/RTBANQ30X96_l.jpg",
            "fileName": "side-T 20x20.jpeg"
        },
        "isActive": true,
        "isAvailable": true,
        "isTaxable": true,

        "name": "8 ft rectangle table",
        "notes": "",
        "orgId": "1EFnp9dnRUnAWQTPO2U4",
        "qbId": "74",
        "rates": [],
        "stock": 16,
        "syncToken": "0",
        "turnaround": null,
        "type": "rental",
        "updateSource": "qbo",
        "updatedBy": "sGn9ZIc0hQPffroyZdAwcjFr7Sq2",
        "updatedOn": {
            "_seconds": 1639157206,
            "_nanoseconds": 767000000
        }
    },
    {
        "availableStock": 200,
        "bundleItems": [],
        "bundleItemsQueryHook": [],
        "categories": [
            {
                "description": "tent items",
                "id": "XtkrpdmUKXPqDsK97j21",
                "name": "Tents",
                "orgId": "1EFnp9dnRUnAWQTPO2U4"
            }
        ],
        "categoriesQueryHook": [
            "XtkrpdmUKXPqDsK97j21"
        ],
        "createdBy": "sGn9ZIc0hQPffroyZdAwcjFr7Sq2",
        "createdOn": {
            "_seconds": 1639157025,
            "_nanoseconds": 744000000
        },
        "depreciation": {
            "depreciationYears": null,
            "initialDate": null,
            "initialValue": null
        },
        "description": "Black Chair",
        "domain": "QBO",
        "id": "xJy9MTonHdlDaNUf13JZ",
        "image": {
            "downloadURL": "https://www.gettent.com/images/SF2250EBK-poly-black-chair-l.jpg",
            "fileName": "side-T 20x20.jpeg"
        },
        "isActive": true,
        "isAvailable": true,
        "isTaxable": true,

        "name": "Black Chair",
        "notes": "",
        "orgId": "1EFnp9dnRUnAWQTPO2U4",
        "qbId": "74",
        "rates": [],
        "stock": 16,
        "syncToken": "0",
        "turnaround": null,
        "type": "rental",
        "updateSource": "qbo",
        "updatedBy": "sGn9ZIc0hQPffroyZdAwcjFr7Sq2",
        "updatedOn": {
            "_seconds": 1639157206,
            "_nanoseconds": 767000000
        }
    },
]



export default class AdelieCart {
    constructor({ marginTop = 100, marginBottom = 20,  color = '#000', secretKey = "a", sticky=false }) {
        function margin(params) {
            if (typeof params !== 'string') {
                params = JSON.stringify(params)
            }
            if (!params.includes('px') && !params.includes('rem')) {
                params = params + 'px'
            }
            return params;
        }
        marginTop = margin(marginTop)
        marginBottom = margin(marginBottom)
        $('head').append(`
            <style>
                :root {
                    --adelie-main-color: ${color}
                }
            </style>
        `)
        this.marginTop = marginTop;
        this.marginBottom = marginBottom
        this.color = color;
        this.secretKey = secretKey;
        this.sticky = sticky
        this.pickupDateTime = localStorage.getItem('pickupDateTime')
        this.returnDateTime = localStorage.getItem('returnDateTime')
        this.categories = []
        this.totalCategoryCount = 0
        this.products = cat
        this?.products?.map((v, i) => {
            v?.categories?.map((val, ind) => {
                if (this?.categories?.filter(e => e.name === val.name).length > 0) {
                    this?.categories?.map((v, i) => {
                        if (v?.name === val.name){
                            v.count = v?.count + 1
                            this.totalCategoryCount += 1
                        }
                    })
                }else{
                    this?.categories.push({id: val.id, name:val.name, count: 1})
                    this.totalCategoryCount += 1
                }
                
            })
        })
        this.productDetailModel = false
        this.productDetail = {}
        this.cart = {}
    }
    async listDateTime() {
        await $('#adelie #adelie_left #adelieDateTime').html(`
            <div class="adelie_left_body">
                <p class='left_p_top adelie-bold adelie-border adelie-padding adelie-border-radius'>Pickup (2pm or later is no charge)</p>
                <input type="datetime-local" value="${this.pickupDateTime}" class="datetime" id="top_datetime" />

                <p class='left_p_bottom adelie-bold adelie-border adelie-padding adelie-border-radius'>Return (10am or earlier is no charge)</p>
                <input type="datetime-local" value="${this.returnDateTime}" class="datetime" id="bottom_datetime" />
            </div>
        `)
    }
    async listingCategories() {
        var data = `<div class='categoryChildren categoryHandler active' data-id="v-all"><span>All</span> <span>${this.totalCategoryCount}</span></div>`
        this?.categories?.map((v, i) => {
            data += `
                <div class='categoryChildren categoryHandler' data-id="${v.id}-${v.name}"><span>${v.name}</span><span>${v.count}</span></div>
            `
        })
        await $('#adelie #adelie_left #adelieCategories').html(data)
    }
    async listingSearch() {
        await $('#adelie #adelie_right #adelieSearch').html(`
            <div style="background-color: ${this.color}">
                <img src="./search.png" height="30" width="30" />
            </div>
            <input id="SearchHandler" type='text' name='search' placeholder='Search Product' />
        `)
        this.listingFunctions()
    }
    daysDifference(date) {
        var date1 = new Date()
        var date2 = new Date(date * 1000)
        var total_seconds = Math.abs(date2 - date1) / 1000;  
        var days_difference = Math.floor(total_seconds / (60 * 60 * 24));
        return days_difference
    }
    async listingProducts() {
        var data = ``
        this?.products?.map((val, ind) => {
            var days_difference = this.daysDifference(val?.createdOn?._seconds)
            data += `
                <div class="adelie_card adelie-col productDetailHandler" data-id="${val?.id}">
                    <img src="${val?.image?.downloadURL}" />
                    <div class="adelie_card_body">
                        <h5 class="adelie_cart">
                            <span>${val?.name}</span>
                            <span class="adelie_cart_button">
                                <img width='25' height="25" src="./shopping-cart.png" />
                            </span>
                        </h5>
                        <p>${days_difference} ${days_difference > 1 ? 'days' : 'day'}</p>
                    </div>
                </div>
            `
        })
        await $('#adelie #adelie_right #adelieProducts').html(data)
        this.listingFunctions()
    }
    async listingProductModel() {
        if (this.productDetailModel) {
            var days_difference = this.daysDifference(this.productDetail?.createdOn?._seconds)
            $('.adelie_model_main').removeClass('adelie_model_none')
            $('.adelie_model_main').html(`
                <div class='adelie_model'>
                    <div class="adelie_model_body">
                        <div id="adelie_model_close">
                            <img src="./close.png" height="15px" width="15px" />
                        </div>
                        <div class="adelie_model_img">
                            <span>
                                <img src="${this.productDetail?.image?.downloadURL}" />
                            </span>
                        </div>
                        <div class="adelie_model_body_details">
                            <h2><span>${this.productDetail.name}</span> <span class="adelie_model_days">${days_difference} ${days_difference > 1 ? 'days' : 'day'}</span></h2>
                            <div class="adelie_model_cart">
                                <input value='1' id="stock-${this.productDetail?.id}" type='number' ${this.productDetail?.availableStock < 1 && 'disabled' } min='1' max='${this.productDetail?.availableStock}' />
                                <button class="adelie_add_to_cart" ${this.productDetail?.availableStock < 1 && 'disabled' } data-id="${this.productDetail?.id}">Add to booking</button>
                                <p class="adelie_heling_text">
                                    ${this.productDetail?.availableStock} available stock
                                </p>
                            </div>
                            <h4>${this.productDetail.name} for Hire</h4>
                            <p>${this.productDetail.description}</p>
                        </div>
                    </div>
                </div>
            `)
            $('body').addClass('noScroll')
            
        }else{
            $('.adelie_model_main').addClass('adelie_model_none')
            $('body').removeClass('noScroll')
        }
    }
    async listingFloatingCartIcon() {
        $('#adelie_floating_cart_icon_main').html(`
            <div class="adelie_floating_cart_icon">
                <div class="adelie_floating_cart_icon_show">
                    <img width='35' height="35" src="./shopping-cart.png" />
                </div>
                <div class="adelie_floating_cart_icon_hide">
                    <span class='adelie_floating_cart_date'>${new Date(this.pickupDateTime).toLocaleDateString()}</span>
                    <span class='adelie_floating_cart_time'>${new Date(this.pickupDateTime).toLocaleTimeString()}</span>
                    -
                    <span class='adelie_floating_cart_date'>${new Date(this.returnDateTime).toLocaleDateString()}</span>
                    <span class='adelie_floating_cart_time'>${new Date(this.returnDateTime).toLocaleTimeString()}</span>
                    <hr />
                    <span class="adelie_floating_cart_items">
                        <span>Items</span>
                        <span>${Object.values(this.cart).length}</span>
                    </span>
                </div>
            </div>
        `)
    }
    async listingFloatingCart() {
        let data = ''
        this.products?.map((v, i) => {
            if (Object.keys(this.cart).includes(v.id)) {
                const qty = this.cart[v.id]
                data += `<div class="adelie_floating_cart_body_product">
                    <div class="adelie_floating_cart_body_product_main">
                        <div data-id="${v?.id}" class="adelie_floating_cart_body_product_close">
                            <img src="./close.png" height="10px" width="10px" />
                        </div>
                        <div class="adelie_floating_cart_body_product_body">
                            <div class="adelie_floating_cart_body_product_image">
                                <img src="${v?.image?.downloadURL}" />
                            </div>
                            <div class="adelie_floating_cart_body_product_name">
                                <h6>${v?.name}</h6>
                                <div class="adelie_floating_cart_body_product_quantity">
                                    <img src="./minus.png" data-id="${v?.id}" class="adelie_floating_cart_minus" />
                                    <span>${qty}</span>
                                    <img src="./plus (1).png" data-id="${v?.id}" class="adelie_floating_cart_plus" />
                                </div>
                            </div>
                        </div>
                    </div>
                </div>`
            }
        })
        $('#adelie_floating_cart_main').html(`
            <div class="adelie_floating_cart">
                <div id="adelie_floating_cart_close">
                    <img src="./close_white.png" height="10px" width="10px" />
                </div>
                <div class="adelie_floating_cart_header">
                    <h6>MY ORDERS</h6>
                    <div class="adelie_floating_cart_dates">
                        <span>${new Date(this.pickupDateTime).toLocaleDateString()}</span>,
                        <span>${new Date(this.pickupDateTime).toLocaleTimeString()}</span>
                        <img src="./next.png" height="15px" width="15px" />
                        <span>${new Date(this.returnDateTime).toLocaleDateString()}</span>,
                        <span>${new Date(this.returnDateTime).toLocaleTimeString()}</span>
                    </div>
                </div>
                <div class="adelie_floating_cart_body">
                    ${data}
                </div>
                <div class="adelie_floating_cart_footer">
                    <button>REQUEST BOOKING</button>
                </div>
            </div>
        `)
    }
    async listing() {
        $('#adelie').css({ 'margin-top': this.marginTop, 'margin-bottom': this.marginBottom })
        await $('#adelie').html(`
            <div class="adelie_model_main adelie_model_none"></div>
            <div id="adelie_left" class='adelie-border adelie-border-radius ${this.sticky && 'adelieLeftSticky'}'>
                <div id="adelieDateTime"></div>
                <div id="adelieCategories"></div>
            </div>
            <div id="adelie_right">
                <div id="adelieSearch" class="${this.sticky && 'adelieSearchSticky'}"></div>
                <div id="adelieProducts" class="adelie-row"></div>
            </div>
            <div id="adelie_floating_cart_main" class="adelie_model_none"></div>
            <div id="adelie_floating_cart_icon_main"></div>
        `)
        await this.listDateTime()
        await this.listingCategories()
        await this.listingSearch()
        await this.listingFloatingCartIcon()
        await this.listingFloatingCart()
        await this.listingProducts()
    }
    async listingFunctions() {
        var a = this
        $('#top_datetime').on('change', function () {
            if (this.value > a.returnDateTime) {
                localStorage.setItem('returnDateTime', this.value)
                localStorage.setItem('pickupDateTime', a.returnDateTime)
                a.pickupDateTime = a.returnDateTime
                a.returnDateTime = this.value
            } else {
                localStorage.setItem('pickupDateTime', this.value)
                a.pickupDateTime = this.value
            }
            a.listDateTime()
            a.listingFunctions()
        })
        $('#bottom_datetime').on('change', function () {
            if (this.value < a.pickupDateTime) {
                localStorage.setItem('pickupDateTime', this.value)
                localStorage.setItem('returnDateTime', a.pickupDateTime)
                a.returnDateTime = a.pickupDateTime
                a.pickupDateTime = this.value
            } else {
                localStorage.setItem('returnDateTime', this.value)
                a.returnDateTime = this.value
            }
            a.listDateTime()
            a.listingFunctions()
        })
        $('#SearchHandler').on('keydown', function (e) {
            if (e.target.value === ''){
                a.products = cat
            }else{
                a.products = cat.filter(v => v.name.toLowerCase().includes(e.target.value.toLowerCase()))
            }
            a.listingProducts()
        })
        $('.categoryHandler').on('click', function () {
            $('.categoryHandler').removeClass('active')
            $(this).addClass('active')
            const [id, name] = $(this).attr('data-id').split('-')
            var products = []
            if (name === 'all'){
                products = cat
            }else{
                cat.filter(v => {
                    v.categories.filter(c => {
                        if (c.name === name && c.id === id){
                            products.push(v)
                        }
                    })
                })
            }
            a.products = products
            a.listingProducts()
        })
        $('.productDetailHandler').on('click', function () {
            const id = $(this).attr('data-id')
            a.productDetail = cat.find(v => v.id == id)
            a.productDetailModel = true
            a.listingProductModel()
            a.listingFunctions()
        })
        $('#adelie_model_close').on('click', function () {
            a.productDetailModel = false
            a.listingProductModel()
        })
        $('.adelie_add_to_cart').on('click', function() {
            const id = $(this).attr('data-id')
            const value = parseInt($(`#stock-${id}`).val())
            if (Object.keys(a.cart).includes(id)){
                a.cart[id] += value
            }else{
                a.cart[id] = value
            }
            a.listingProductModel()
            a.listingFloatingCartIcon()
            a.listingFloatingCart()
            a.listingFunctions()
        })
        $('#adelie_floating_cart_icon_main').on('click', function () {
            $(this).addClass('adelie_model_none')
            $('#adelie_floating_cart_main').removeClass('adelie_model_none')
        })
        $('#adelie_floating_cart_close').on('click', function () {
            $('#adelie_floating_cart_main').addClass('adelie_model_none')
            $('#adelie_floating_cart_icon_main').removeClass('adelie_model_none')
        })
        $('.adelie_floating_cart_minus').on('click', function () {
            const id = $(this).attr('data-id')
            if (Object.keys(a.cart).includes(id)) {
                if (a.cart[id] >= 2) {
                    a.cart[id] -= 1
                }else {
                    delete a.cart[id]
                }
                a.listingFloatingCartIcon()
                a.listingFloatingCart()
                a.listingFunctions()
            }
        })
        $('.adelie_floating_cart_plus').on('click', function () {
            const id = $(this).attr('data-id')
            if (Object.keys(a.cart).includes(id) && a.products.find(e => e.id === id).availableStock > a.cart[id]) {
                a.cart[id] += 1
                a.listingFloatingCartIcon()
                a.listingFloatingCart()
                a.listingFunctions()
            }
        })
        $('.adelie_floating_cart_body_product_close').on('click', function () {
            const id = $(this).attr('data-id')
            if (Object.keys(a.cart).includes(id)){
                delete a.cart[id]
                a.listingFloatingCartIcon()
                a.listingFloatingCart()
                a.listingFunctions()
            }
        })
    }
    async init() {
        if (this.secretKey) {
            await this.listing()
            await this.listingFunctions()
        } else {
            console.log("Please provide the secretKey")
        }
    }
}